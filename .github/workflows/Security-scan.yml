name: strix-penetration-test

on:
  workflow_dispatch:
    inputs:
      decryption_password:
        description: 'Password to decrypt QWEN_TOKENS'
        required: true
        type: string
      target:
        description: 'Target to scan (URL, path, or repository)'
        required: false
        default: './'
        type: string
      prompt:
        description: 'Custom instructions for the AI agent'
        required: false
        default: ''
        type: string
      timeframe:
        description: 'Maximum runtime in minutes (10-720)'
        required: false
        default: '60'
        type: choice
        options:
          - '10'
          - '15'
          - '30'
          - '60'
          - '90'
          - '120'
          - '180'
          - '240'
          - '360'
          - '480'
          - '720'
      scan_mode:
        description: 'Scan mode'
        required: false
        default: 'deep'
        type: choice
        options:
          - quick
          - standard
          - deep
      model:
        description: 'AI Model to use'
        required: false
        default: 'qwen3-coder-plus'
        type: choice
        options:
          - 'qwen3-coder-plus'
          - 'qwen3-coder-flash'
          - 'qwen3-max'
          - 'qwen-plus'
      reencrypt_tokens:
        description: 'Re-encrypt and update QWEN_TOKENS after scan'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  pull_request:

concurrency:
  group: strix-scan-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  DEFAULT_TIMEFRAME: '60'
  DEFAULT_SCAN_MODE: 'deep'
  CLIPROXY_PORT: '8317'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeframe || '60') }}
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Decrypt Qwen Tokens
        id: decrypt
        run: |
          set -euo pipefail
          echo "::group::Decrypting Qwen tokens"
          if [ -z "${{ secrets.QWEN_TOKENS }}" ]; then
            echo "::error::QWEN_TOKENS secret is not set"
            exit 1
          fi
          mkdir -p ~/.cli-proxy-api
          cd ~/.cli-proxy-api
          echo "${{ secrets.QWEN_TOKENS }}" | base64 -d > qwen-tokens.enc
          if ! echo "${{ github.event.inputs.decryption_password }}" | openssl enc -aes-256-cbc -d -salt -pbkdf2 -in qwen-tokens.enc -out qwen-tokens.tar.gz -pass stdin 2>/dev/null; then
            echo "::error::Failed to decrypt tokens"
            exit 1
          fi
          tar -xzf qwen-tokens.tar.gz
          for dir in account-*/; do
            [ -d "$dir" ] && mv "$dir"qwen-*.json . 2>/dev/null || true
          done
          TOKEN_COUNT=$(find . -maxdepth 1 -name 'qwen-*.json' | wc -l)
          if [ "$TOKEN_COUNT" -eq 0 ]; then
            echo "::error::No token files found"
            exit 1
          fi
          echo "Decrypted $TOKEN_COUNT account(s)"
          echo "token_count=$TOKEN_COUNT" >> "$GITHUB_OUTPUT"
          rm -f qwen-tokens.enc qwen-tokens.tar.gz
          echo "::endgroup::"

      - name: Install CLIProxyAPI
        run: |
          set -euo pipefail
          echo "::group::Installing CLIProxyAPI"
          git clone --depth 1 https://github.com/router-for-me/CLIProxyAPI.git /tmp/CLIProxyAPI
          cd /tmp/CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/
          echo "CLIProxyAPI installed"
          echo "::endgroup::"

      - name: Install SAST Tools
        run: |
          set -euo pipefail
          echo "::group::Installing SAST Tools"
          pip install semgrep bandit trufflehog detect-secrets checkov safety pip-audit 2>/dev/null || true
          git clone --depth 1 https://github.com/wireghoul/graudit.git /opt/graudit 2>/dev/null || true
          [ -f /opt/graudit/graudit ] && sudo ln -sf /opt/graudit/graudit /usr/local/bin/graudit || true
          curl -sfL https://raw.githubusercontent.com/Bearer/bearer/main/contrib/install.sh | sh -s -- -b /usr/local/bin 2>/dev/null || true
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz -C /usr/local/bin gitleaks 2>/dev/null || true
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin 2>/dev/null || true
          gem install brakeman --no-document 2>/dev/null || true
          npm install -g snyk 2>/dev/null || true
          echo "SAST tools installed"
          echo "::endgroup::"

      - name: Install DAST Tools
        run: |
          set -euo pipefail
          echo "::group::Installing DAST Tools"
          sudo apt-get update -qq && sudo apt-get install -y -qq nmap nikto dnsutils whois netcat-openbsd jq curl wget unzip || true
          curl -sSfL https://github.com/projectdiscovery/nuclei/releases/download/v3.2.9/nuclei_3.2.9_linux_amd64.zip -o /tmp/nuclei.zip && unzip -q /tmp/nuclei.zip -d /usr/local/bin 2>/dev/null || true
          nuclei -update-templates 2>/dev/null || true
          curl -sSfL https://github.com/ffuf/ffuf/releases/download/v2.1.0/ffuf_2.1.0_linux_amd64.tar.gz | tar xz -C /usr/local/bin ffuf 2>/dev/null || true
          curl -sSfL https://github.com/projectdiscovery/httpx/releases/download/v1.6.3/httpx_1.6.3_linux_amd64.zip -o /tmp/httpx.zip && unzip -q /tmp/httpx.zip -d /usr/local/bin 2>/dev/null || true
          curl -sSfL https://github.com/projectdiscovery/subfinder/releases/download/v2.6.6/subfinder_2.6.6_linux_amd64.zip -o /tmp/subfinder.zip && unzip -q /tmp/subfinder.zip -d /usr/local/bin 2>/dev/null || true
          pip install sqlmap dirsearch arjun 2>/dev/null || true
          curl -sSfL https://github.com/hahwul/dalfox/releases/download/v2.9.3/dalfox_2.9.3_linux_amd64.tar.gz | tar xz -C /usr/local/bin dalfox 2>/dev/null || true
          echo "$HOME/go/bin" >> $GITHUB_PATH
          echo "DAST tools installed"
          echo "::endgroup::"

      - name: Verify Tools
        run: |
          echo "=== SAST ===" && semgrep --version 2>/dev/null || true && bandit --version 2>/dev/null || true
          echo "=== DAST ===" && nuclei -version 2>/dev/null || true && nmap --version 2>/dev/null | head -1

      - name: Configure CLIProxyAPI
        run: |
          AUTH_DIR="$HOME/.cli-proxy-api"
          cat > "$AUTH_DIR/config.yaml" << 'CONFIGEOF'
          host: "127.0.0.1"
          port: 8317
          auth-dir: "~/.cli-proxy-api"
          debug: true
          request-retry: 5
          routing:
            strategy: "round-robin"
          CONFIGEOF
          sed -i 's/^          //' "$AUTH_DIR/config.yaml"

      - name: Start CLIProxyAPI Server
        id: cliproxy
        run: |
          AUTH_DIR="$HOME/.cli-proxy-api"
          cd "$AUTH_DIR"
          nohup cli-proxy-api -config config.yaml > cliproxy.log 2>&1 &
          echo "$!" > cliproxy.pid
          sleep 15
          for i in {1..20}; do
            if curl -s "http://127.0.0.1:${{ env.CLIPROXY_PORT }}/v1/models" | jq -e '.data' > /dev/null 2>&1; then
              echo "CLIProxyAPI ready"
              break
            fi
            sleep 3
          done
          echo "endpoint=http://127.0.0.1:${{ env.CLIPROXY_PORT }}/v1" >> "$GITHUB_OUTPUT"

      - name: Install Strix from Source
        run: |
          git clone --depth 1 https://github.com/89pl/Strixer.git /tmp/strix-source
          cd /tmp/strix-source
          pip install -e ".[sandbox]" || pip install -e .
          strix --version || python -c "import strix; print('Strix installed')"

      - name: Run Strix Security Scan
        id: strix
        timeout-minutes: ${{ fromJSON(github.event.inputs.timeframe || env.DEFAULT_TIMEFRAME) }}
        continue-on-error: true
        env:
          STRIXDB_TOKEN: ${{ secrets.STRIXDB_TOKEN }}
          CLIPROXY_ENDPOINT: ${{ steps.cliproxy.outputs.endpoint }}
          LLM_API_BASE: ${{ steps.cliproxy.outputs.endpoint }}
          OPENAI_API_KEY: sk-dummy-key-for-cliproxy
          OPENAI_API_BASE: ${{ steps.cliproxy.outputs.endpoint }}
          STRIX_LLM: ${{ github.event.inputs.model || 'qwen3-coder-plus' }}
          STRIX_SCAN_DURATION_MINUTES: ${{ github.event.inputs.timeframe || '60' }}
          STRIX_USE_HOST_NETWORK: 'true'
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        run: |
          set +e
          TARGET="${{ github.event.inputs.target || './' }}"
          TIMEFRAME="${{ github.event.inputs.timeframe || '60' }}"
          SCAN_MODE="${{ github.event.inputs.scan_mode || 'deep' }}"
          export STRIX_SCAN_START_TIME=$(date +%s)
          USER_PROMPT="${{ github.event.inputs.prompt }}"
          EXTRA_INSTRUCTIONS="You have ${TIMEFRAME} minutes. Use get_remaining_time() regularly. Save useful workflows to StrixDB/workflows category."
          if [ -n "$USER_PROMPT" ]; then
            FULL_INSTRUCTIONS="${USER_PROMPT}. ${EXTRA_INSTRUCTIONS}"
          else
            FULL_INSTRUCTIONS="${EXTRA_INSTRUCTIONS}"
          fi
          echo "Target: $TARGET | Timeframe: $TIMEFRAME min | Mode: $SCAN_MODE"
          strix --target "$TARGET" --scan-mode "$SCAN_MODE" --non-interactive --instruction "$FULL_INSTRUCTIONS" 2>&1 | tee strix_output.log
          EXIT_CODE=${PIPESTATUS[0]}
          VULN_COUNT=$(grep -ciE "vulnerability|CVE-|critical|high" strix_output.log 2>/dev/null || echo "0")
          echo "scan_completed=true" >> "$GITHUB_OUTPUT"
          echo "vulnerabilities_found=$VULN_COUNT" >> "$GITHUB_OUTPUT"
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Stop CLIProxyAPI Server
        if: always()
        run: |
          AUTH_DIR="$HOME/.cli-proxy-api"
          [ -f "$AUTH_DIR/cliproxy.pid" ] && kill $(cat "$AUTH_DIR/cliproxy.pid") 2>/dev/null || true

      - name: Re-encrypt and Update QWEN_TOKENS
        if: always() && github.event.inputs.reencrypt_tokens == 'true'
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          SERVER_TOKEN: ${{ secrets.SERVER_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "::group::Re-encrypting Qwen tokens"
          if [ -z "$ENCRYPTION_KEY" ]; then
            echo "::warning::ENCRYPTION_KEY not set. Skipping."
            exit 0
          fi
          if [ -z "$SERVER_TOKEN" ]; then
            echo "::warning::SERVER_TOKEN not set. Skipping."
            exit 0
          fi
          AUTH_DIR="$HOME/.cli-proxy-api"
          cd "$AUTH_DIR"
          TOKEN_COUNT=$(find . -maxdepth 1 -name 'qwen-*.json' 2>/dev/null | wc -l)
          if [ "$TOKEN_COUNT" -eq 0 ]; then
            echo "::warning::No tokens to re-encrypt"
            exit 0
          fi
          echo "Re-encrypting $TOKEN_COUNT token(s)"
          mkdir -p tokens_backup
          ACCOUNT_NUM=1
          for token_file in qwen-*.json; do
            if [ -f "$token_file" ]; then
              mkdir -p "tokens_backup/account-${ACCOUNT_NUM}"
              cp "$token_file" "tokens_backup/account-${ACCOUNT_NUM}/"
              ACCOUNT_NUM=$((ACCOUNT_NUM + 1))
            fi
          done
          cd tokens_backup && tar -czf ../qwen-tokens-new.tar.gz . && cd ..
          echo "$ENCRYPTION_KEY" | openssl enc -aes-256-cbc -salt -pbkdf2 -in qwen-tokens-new.tar.gz -out qwen-tokens-new.enc -pass stdin
          NEW_SECRET_VALUE=$(base64 -w 0 qwen-tokens-new.enc)
          echo "Encrypted (${#NEW_SECRET_VALUE} bytes)"
          KEY_RESPONSE=$(curl -s -H "Authorization: Bearer $SERVER_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$GH_REPO/actions/secrets/public-key")
          PUBLIC_KEY=$(echo "$KEY_RESPONSE" | jq -r '.key')
          KEY_ID=$(echo "$KEY_RESPONSE" | jq -r '.key_id')
          if [ -z "$PUBLIC_KEY" ] || [ "$PUBLIC_KEY" = "null" ]; then
            echo "::error::Failed to get public key"
            exit 1
          fi
          pip install pynacl -q
          python3 -c "
          import base64, sys, os
          from nacl import encoding, public
          pk = base64.b64decode(os.environ['PUBLIC_KEY'])
          sv = open('secret_value.txt').read()
          box = public.SealedBox(public.PublicKey(pk))
          enc = box.encrypt(sv.encode('utf-8'))
          print(base64.b64encode(enc).decode('utf-8'))
          " > encrypted_value.txt <<< "$NEW_SECRET_VALUE"
          echo "$NEW_SECRET_VALUE" > secret_value.txt
          export PUBLIC_KEY
          ENCRYPTED_VALUE=$(python3 -c "
          import base64, os
          from nacl import public
          pk = base64.b64decode(os.environ['PUBLIC_KEY'])
          sv = open('secret_value.txt').read().strip()
          box = public.SealedBox(public.PublicKey(pk))
          enc = box.encrypt(sv.encode('utf-8'))
          print(base64.b64encode(enc).decode('utf-8'))
          ")
          curl -s -X PUT -H "Authorization: Bearer $SERVER_TOKEN" -H "Accept: application/vnd.github+json" -H "Content-Type: application/json" "https://api.github.com/repos/$GH_REPO/actions/secrets/QWEN_TOKENS" -d "{\"encrypted_value\":\"$ENCRYPTED_VALUE\",\"key_id\":\"$KEY_ID\"}"
          echo "QWEN_TOKENS secret updated!"
          rm -rf tokens_backup qwen-tokens-new.tar.gz qwen-tokens-new.enc secret_value.txt
          echo "::endgroup::"

      - name: Cleanup Token Files
        if: always()
        run: |
          rm -rf "$HOME/.cli-proxy-api"/qwen-*.json "$HOME/.cli-proxy-api/cliproxy.pid" 2>/dev/null || true

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: strix-results-${{ github.run_id }}
          path: |
            strix_runs/
            strix_output.log
            ~/.cli-proxy-api/cliproxy.log
          retention-days: 30

      - name: Create Security Summary
        if: always()
        run: |
          REENCRYPT="${{ github.event.inputs.reencrypt_tokens || 'true' }}"
          echo "# Strix Security Scan" > "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Configuration" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Target**: \`${{ github.event.inputs.target || './' }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Mode**: ${{ github.event.inputs.scan_mode || 'deep' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Model**: ${{ github.event.inputs.model || 'qwen3-coder-plus' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Duration**: ${{ github.event.inputs.timeframe || '60' }} minutes" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Token Re-encryption**: $REENCRYPT" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "$REENCRYPT" = "true" ]; then
            echo "Tokens re-encrypted automatically. No need to run Qwen.yml." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Token re-encryption disabled. Run Qwen.yml to refresh." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "*Strix AI Scanner (89pl/Strixer)*" >> "$GITHUB_STEP_SUMMARY"